# Paper Trading System

A simulated trading system with multiple strategy agents that generate recommendations, track outcomes, and measure performance over time.

## Overview

The paper trading system runs three strategy agents every 15 minutes:

| Strategy | Logic | Signal Type |
|----------|-------|-------------|
| **Funding Arbitrage** | High funding = SHORT, Low funding = LONG | Carry trade |
| **Grid Trading** | Range detection, buy low/sell high | Mean reversion |
| **Directional Momentum** | RSI, EMA crossover, volume | Trend following |

## Quick Start

### 1. Setup Database

Run the SQL in Supabase to create tables:

```bash
# Copy and run in Supabase SQL Editor
scripts/paper_trading/sql/create_tables.sql
```

### 2. Configure Environment

```bash
# Required for database persistence
SUPABASE_URL=your_supabase_url
SUPABASE_KEY=your_supabase_key

# Optional for Telegram alerts
TELEGRAM_BOT_TOKEN=your_bot_token
TELEGRAM_CHAT_ID=your_chat_id

# Required for grid/directional strategies
HYP_KEY=your_hyperliquid_key
HYP_SECRET=your_hyperliquid_secret
```

### 3. Run Strategies

```bash
# Single iteration (for testing)
python -m scripts.paper_trading.run_once --dry-run

# Run specific strategy
python -m scripts.paper_trading.run_once --strategy funding

# Start scheduler (runs continuously)
python -m scripts.paper_trading.scheduler

# Generate review report
python -m scripts.paper_trading.scheduler --review 24h
```

## Architecture

```
scripts/paper_trading/
    __init__.py              # Package exports
    base_strategy.py         # BaseStrategy class, Recommendation dataclass
    metrics_calculator.py    # Performance tracking and reporting
    scheduler.py             # APScheduler-based runner
    run_once.py              # Single iteration runner
    strategies/
        __init__.py
        funding_strategy.py  # Funding arbitrage
        grid_strategy.py     # Grid/range trading
        directional_strategy.py  # Momentum
    sql/
        create_tables.sql    # Supabase schema
```

## Database Schema

### paper_recommendations
Stores all signals generated by strategies.

| Column | Type | Description |
|--------|------|-------------|
| id | UUID | Primary key |
| created_at | TIMESTAMPTZ | Signal generation time |
| strategy_name | TEXT | Which strategy generated this |
| symbol | TEXT | Trading pair (e.g., "BTC") |
| direction | TEXT | LONG, SHORT, or HOLD |
| entry_price | NUMERIC | Price at signal time |
| target_price_1 | NUMERIC | Take profit level |
| stop_loss_price | NUMERIC | Stop loss level |
| confidence_score | INTEGER | 0-100 confidence |
| status | TEXT | ACTIVE, TARGET_HIT, STOPPED, EXPIRED |
| expires_at | TIMESTAMPTZ | When signal expires |
| strategy_params | JSONB | Strategy-specific data |

### paper_recommendation_outcomes
Tracks what happened to each signal.

| Column | Type | Description |
|--------|------|-------------|
| recommendation_id | UUID | Links to recommendation |
| outcome_time | TIMESTAMPTZ | When outcome occurred |
| outcome_type | TEXT | TARGET_HIT, STOPPED, EXPIRED |
| exit_price | NUMERIC | Price at outcome |
| pnl_pct | NUMERIC | Percentage P&L |
| pnl_usd | NUMERIC | USD P&L (based on $1000 position) |
| hold_duration_minutes | INTEGER | How long position was held |

### paper_strategy_metrics
Aggregated metrics per strategy.

| Column | Type | Description |
|--------|------|-------------|
| strategy_name | TEXT | Strategy identifier |
| period | TEXT | 24h, 7d, 30d, all_time |
| win_rate | NUMERIC | Percentage of winning trades |
| total_pnl_pct | NUMERIC | Total P&L percentage |
| profit_factor | NUMERIC | Gross profit / gross loss |
| sharpe_ratio | NUMERIC | Risk-adjusted return |

## Strategies

### Funding Arbitrage

Exploits extreme funding rates on perpetual contracts.

- **LONG** when funding is very negative (you receive funding)
- **SHORT** when funding is very positive (you receive funding)
- Low leverage carry trade approach
- 8-hour expiry (one funding period)

Parameters:
- `min_funding_rate`: 0.01% per 8h (default)
- `stop_loss_multiple`: 2x daily funding

### Grid Trading

Mean reversion within detected price ranges.

- Identifies 24h high/low range
- **LONG** near range bottom
- **SHORT** near range top
- Confirms with RSI
- 24-hour expiry

Parameters:
- `lookback_hours`: 24 (default)
- `range_threshold_pct`: 3% minimum range
- `entry_zone_pct`: 20% of range from boundary

### Directional Momentum

Trend following using multiple indicators.

- Scores assets based on 24h change, RSI, EMAs, volume
- **LONG** for strong bullish momentum
- **SHORT** for strong bearish momentum
- ATR-based stops
- 24-hour expiry

Parameters:
- `min_score`: 60/100 (default)
- `min_change_24h`: 2% minimum move
- `risk_reward_ratio`: 1.5x

## Telegram Integration

When signals are generated:
```
*PAPER SIGNAL*: BTC LONG
Strategy: directional_momentum
Entry: $83,500.0000
Target: $85,200.0000 (+2.0%)
Stop: $82,000.0000 (-1.8%)
Confidence: 75/100
R:R: 1.1x
```

When outcomes occur:
```
*SIGNAL RESULT*: BTC LONG
Outcome: TARGET HIT
P&L: +2.00% (+$20.00)
Duration: 4h 15m
```

Daily summary:
```
*PAPER TRADING SUMMARY* (24h)

*Funding Arbitrage*
  5W/2L (71%) | +1.2%

*Grid Trading*
  7W/4L (64%) | +0.8%

*Directional Momentum*
  2W/2L (50%) | -0.2%

*Combined*: +1.8% (+$18)
```

## CLI Commands

Available via Claude Code:

- `/paper-trading:status` - View current performance
- `/paper-trading:review 24h` - Generate review report
- `/paper-trading:start` - Start the scheduler

## Schedule

| Task | Frequency | Description |
|------|-----------|-------------|
| Signal generation | Every 15 min | Run all strategies |
| Outcome checks | Every 15 min | Check for TP/SL/expiry |
| Metrics update | Every 1 hour | Recalculate statistics |
| Daily review | 00:00 UTC | Generate daily digest |

## Configuration

Default position size: $1000 (paper only)

To change strategy parameters, edit the scheduler initialization:

```python
self.strategies = [
    FundingStrategy(
        min_funding_rate=0.02,  # More selective
        max_signals_per_run=5   # More signals
    ),
    # ...
]
```
